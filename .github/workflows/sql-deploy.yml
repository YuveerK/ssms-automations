name: SSMS Database Automation

on:
  push:
    paths:
      - "DatabaseAdministration/SQLStatements/**.sql"
    branches:
      - main

jobs:
  deploy:
    runs-on: self-hosted

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Execute SQL Scripts with Windows Authentication
        shell: powershell
        run: |
          $server = "YUVEER"  # Use Windows Authentication, no need for username/password

          # Run all SQL scripts in order
          $scripts = @(
              "create_database.sql",
              "create_table.sql",
              "insert_user_sp.sql",
              "insert_data.sql"
          )

          foreach ($script in $scripts) {
              Write-Host "Executing script: $script..."
              sqlcmd -S $server -E -d AutoTest -i "DatabaseAdministration/SQLStatements/$script"
          }

          Write-Host "âœ… Database setup complete!"

      - name: Start ngrok to expose SQL Server
        shell: powershell
        run: |
          Start-Process -NoNewWindow -FilePath "ngrok.exe" -ArgumentList "tcp 1433"
          Start-Sleep -Seconds 5
          $ngrokURL = & "ngrok.exe" tcp 1433 | Select-String "tcp://" | ForEach-Object { $_.Matches.Value }
          Write-Host "ðŸš€ SQL Server is publicly accessible at: $ngrokURL"
