name: SSMS Database Automation

on:
  push:
    paths:
      - "DatabaseAdministration/SQLStatements/**.sql"
    branches:
      - main

jobs:
  deploy:
    runs-on: self-hosted

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Execute SQL Scripts with SQL Authentication
        shell: powershell
        run: |
          $server = "YUVEER"
          $username = "Auto_user"
          $password = "StrongPassword123"

          # Step 1: Run create_database.sql without -d AutoTest
          Write-Host "Executing script: create_database.sql..."
          sqlcmd -S $server -U $username -P $password -i "DatabaseAdministration/SQLStatements/create_database.sql"

          # Step 2: Run the remaining scripts with -d AutoTest
          $scripts = @(
              "create_table.sql",
              "insert_user_sp.sql",
              "insert_data.sql"
          )

          foreach ($script in $scripts) {
              Write-Host "Executing script: $script..."
              sqlcmd -S $server -U $username -P $password -d AutoTest -i "DatabaseAdministration/SQLStatements/$script"
          }

          Write-Host "Database setup complete!"

      - name: Download and Install ngrok v3 if not available
        shell: powershell
        run: |
          $ngrokPath = "C:\ngrok\ngrok.exe"
          if (-Not (Test-Path $ngrokPath)) {
              Write-Host "Downloading ngrok v3..."
              # This link is current as of early 2024. If it breaks, check https://ngrok.com/download.
              $ngrokUrl = "https://bin.equinox.io/c/bNyj1mQVY4c/ngrok-v3-stable-windows-amd64.zip"
              
              Invoke-WebRequest -Uri $ngrokUrl -OutFile ngrok.zip
              Expand-Archive -Path ngrok.zip -DestinationPath C:\ngrok -Force
              Remove-Item ngrok.zip -Force
              Write-Host "Ngrok v3 installed successfully!"
          } else {
              Write-Host "Ngrok already installed."
          }

      - name: Configure ngrok
        shell: powershell
        env:
          NGROK_AUTH_TOKEN: ${{ secrets.NGROK_AUTH_TOKEN }}
        run: |
          $ngrokPath = "C:\ngrok\ngrok.exe"
          if (-Not (Test-Path $ngrokPath)) {
              Write-Host "Ngrok not found!"
              exit 1
          }

          Write-Host "Configuring ngrok with authtoken..."
          & $ngrokPath authtoken $env:NGROK_AUTH_TOKEN
          Write-Host "ngrok configured!"

      - name: Start ngrok to expose SQL Server
        shell: powershell
        run: |
          $ngrokPath = "C:\ngrok\ngrok.exe"
          if (-Not (Test-Path $ngrokPath)) {
              Write-Host "Ngrok not found! Please install it and update the path."
              exit 1
          }

          Write-Host "Starting ngrok..."
          Start-Process -NoNewWindow -FilePath $ngrokPath -ArgumentList "tcp 1433"
          Start-Sleep -Seconds 5

          # Capture ngrok public URL
          $ngrokURL = & $ngrokPath tcp status | Select-String "tcp://" | ForEach-Object { $_.Matches.Value }
          Write-Host "SQL Server is publicly accessible at: $ngrokURL"
